/**
 * Script migliorato per gestire i dati del form XD Ped e inserirli in un Google Sheet
 */

// Funzione doGet per servire una risposta semplice
function doGet() {
  return HtmlService.createHtmlOutput('Questa è una web app per il form XD Ped. Utilizza il form per inviare i dati.')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// Funzione doPost che riceve i dati dal form
function doPost(e) {
  // Aggiungi log per debugging
  console.log("Ricevuta richiesta POST");
  console.log("Dati ricevuti: " + e.postData.contents);
  
  // Imposta intestazioni CORS
  var output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  
  try {
    // Ottieni i dati JSON inviati dal form
    const data = JSON.parse(e.postData.contents);
    console.log("Dati parsati: ", JSON.stringify(data));
    
    // Apri il foglio Google Sheet per ID
    // IMPORTANTE: Sostituisci questo con il tuo ID di Google Sheet
    const ss = SpreadsheetApp.openById('16DgUSDFXYyytP4pl8qF2LwBFsnHfzbj5fA2Vz3VL8Is);
    console.log("Foglio aperto con successo");
    
    // Ottieni o crea il foglio
    const sheet = ss.getSheetByName('Report XD Ped') || ss.insertSheet('Report XD Ped');
    console.log("Foglio 'Report XD Ped' selezionato");
    
    // Controlla se ci sono già intestazioni, altrimenti aggiungile
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(['Data e Ora', 'Punto Vendita', 'Peso XD Ped (%)', 'Data Inserimento']);
      sheet.getRange(1, 1, 1, 4).setFontWeight('bold');
      console.log("Intestazioni aggiunte");
    }
    
    // Formatta il timestamp in data/ora leggibile
    const timestamp = new Date(data.timestamp);
    const formattedDate = Utilities.formatDate(timestamp, 'Europe/Rome', 'dd/MM/yyyy HH:mm:ss');
    
    // Data di inserimento (solo data)
    const currentDate = Utilities.formatDate(new Date(), 'Europe/Rome', 'dd/MM/yyyy');
    
    // Inserisci i dati nel foglio
    sheet.appendRow([
      formattedDate,
      data.store,
      data.peso,
      currentDate
    ]);
    console.log("Dati inseriti nel foglio");
    
    // Restituisci una risposta di successo
    output.setContent(JSON.stringify({ 
      result: 'success', 
      message: 'Dati inseriti con successo' 
    }));
    
    return output;
    
  } catch (error) {
    // Registra l'errore nel log
    console.error('Errore durante l\'elaborazione dei dati: ' + error);
    
    // Restituisci un messaggio di errore dettagliato
    output.setContent(JSON.stringify({ 
      result: 'error', 
      message: error.toString(),
      stack: error.stack
    }));
    
    return output;
  }
}
